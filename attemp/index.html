<!DOCTYPE html>
<html>
<head>
  
  <title>Attemp</title>
  <link type="image/x-icon" rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIElEQVQ4T2NkYGD4D8RkA8ZRAxhGw4BhNAyA+WAYpAMATk4QAVU91ZsAAAAASUVORK5CYII="/>
  <meta charset="utf-8"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta content="Local web app development host for TMPmachine" name="Description"/>
  <meta content="Local web app development host for TMPmachine" property="og:description"/>
  
</head>
<body>
  
  <script src="/idb.js"></script>
  <script>
  
    (function() {
      
      // service worker handler
      if (typeof(navigator) !== 'undefined' && 'serviceWorker' in navigator) {
        navigator.serviceWorker.addEventListener('controllerchange',function() {
          location.href = location.href;
        });
        
        navigator.serviceWorker.register('/sw.js').then(function(swo) {
          if (!navigator.serviceWorker.controller)
            return;
      
          if (swo.waiting) {
            swo.waiting.postMessage({action: 'skipWaiting'});
            location.href = location.href;
            
            return;
          }
      
          if (swo.installing) {
            swo.installing.addEventListener('statechange',function(e) {
              if (swo.installing.state == 'installed')
              {
                swo.waiting.postMessage({action: 'skipWaiting'});
                location.href = location.href;
              }
            })
            return;
          }
          
          swo.addEventListener('updatefound',function() {
            swo.installing.addEventListener('statechange',function(e) {
              if (this.state == 'installed')
              {
                swo.waiting.postMessage({action: 'skipWaiting'});
                location.href = location.href;
              }
            })
          })
        }).catch(function(e) {
          console.error('Something went wrong.')
        });
      }
      
    })();
  
  </script>
  <script>
  
    (function() {
      
      let L = console.log;
      
      function writeHTML(HTML) {
        document.open();
        document.write(HTML.replace(/<head>(\s|\S)*?<\/head>/, ''));
        const head = HTML.match(/<head>(\s|\S)*?<\/head>/);
        if (head)
          document.head.innerHTML = head[0].substring(6, head[0].length-7);
        document.close();
      }
      
      if (localStorage.getItem('__PWAData')) {
        let data = JSON.parse(localStorage.getItem('__PWAData'))
        loadManifest.appName = data.appName;
        loadManifest.appLink = data.appLink;
        
        document.head.appendChild(loadManifest());
        window.addEventListener('beforeinstallprompt', handleInstall);
        localStorage.removeItem('__PWAData');
      }
      
      if (window.location.href.includes('localapp')) {
        
        let appName = window.location.href.split('localapp/')[1].split('/')[0].split('?')[0].split('&')[0].split('#')[0];
        let interval = setInterval(() => {
          
          if (window.attemp_db.db) {
            window.attemp_db.setStore('apps');
            window.attemp_db.get(appName, appData => {
              if (appData)
                writeHTML(appData.html);
              else
                document.write('App data: <b>'+appName+'</b> not found. Please reinstall web app from TMPmachine.');
            });
            clearInterval(interval);
          }
        }, 10)
      }
      
      function loadManifest() {
        
        window.URL = window.URL || window.webkitURL;
        
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d');
        
        if (typeof(src128) === 'undefined') {
          canvas.width = 128;
          canvas.height = 128;
          ctx.fillRect(0,0,128,128);
          src128 = canvas.toDataURL();
        }
        
        if (typeof(src192) === 'undefined') {
          canvas.width = 192;
          canvas.height = 192;
          ctx.fillRect(0,0,192,192);
          src192 = canvas.toDataURL();
        }
        
        let blob = new Blob([`{"name": "${loadManifest.appName}", "icons": [{ "src": "${src128}", "type": "image/png", "sizes": "128x128" }, { "src": "${src192}", "type": "image/png", "sizes": "192x192" }], "scope": "https://attemp.web.app/localapp/${loadManifest.appLink}", "start_url": "https://attemp.web.app/localapp/${loadManifest.appLink}", "display": "standalone", "background_color": "#596d92", "theme_color": "#3f5173" }`], {type: 'application/json'});
  
        let link = document.createElement('link');
        link.rel = 'manifest';
        link.href = window.URL.createObjectURL(blob);
        return link;
      }
      
      window.addEventListener('message', thorReceiver, false);
      
      function thorRunJS(js) {
        for (let j of js) {
          let s = document.createElement('script');
          if (j.startsWith('<script>')) {
            s.textContent = j.substring(8, j.length-9);
          } else {
            s.src = j.substring(13, j.length-11);
          }
          document.body.appendChild(s);
        }
      }
      
      function thorGetJS(xml) {
        let scripts = xml.match(/<script>(.|\n)*?<\/script>/g);
        
        if (scripts === null) return {xml:xml, js:[]};
        for (let script of scripts)
          xml = xml.replace(script, '');
        
        return {xml:xml, js:scripts}
      }
      
      function thorRefreshIcon() {
        setTimeout(function(){
          var link = document.querySelector("link[rel*='icon']");
          if (!link) {
            link = document.createElement('link')
            link.href = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIElEQVQ4T2NkYGD4D8RkA8ZRAxhGw4BhNAyA+WAYpAMATk4QAVU91ZsAAAAASUVORK5CYII=';
          }
          
          link.type = 'image/x-icon';
          link.rel = 'shortcut icon';
          document.getElementsByTagName('head')[0].appendChild(link);
          
          if (document.querySelector('title') === null)
            document.title = 'Attemp'
        },500)
        
      }
      
      function thorLoad(js) {
        thorRunJS(js);
        thorRefreshIcon();
        window.addEventListener('message', thorReceiver, false);
        window.opener.postMessage({type:'readyToDeploy'},'*');
      }
      
      function runHeadJS(xml) {
        let scripts = xml.match(/<script src=.*?><\/script>/g);
        if (scripts) {
          for (let script of scripts)
            document.write(script);
        }
      }
      
      function thorReceiver(e) {
        if (e.data.type != undefined && e.data.type == 'template') {
          
          let data = thorGetJS(e.data.xml);
          
          document.open();
          let head = data.xml.match(/<head>(\s|\S)*?<\/head>/);
          document.write(data.xml.replace(/<head>(\s|\S)*?<\/head>/,''));
          if (head) {
            document.head.innerHTML = head[0].substring(6,head[0].length-7);
            runHeadJS(head[0]);
          }
          document.close();
          
          if (e.data.isPWAEnabled) {
            
            if (e.data.appName.trim().length == 0)
              e.data.appName = 'Untitled App';
            let appName = e.data.appName;
            let appLink = appName.replace(/ +|_+/g,'-').replace(/-+/,'-').toLowerCase();
            loadManifest.appName = appName;
            loadManifest.appLink = appLink;
            
            localStorage.setItem('__PWAData', JSON.stringify({
              appName,
              appLink
            }));
            
            attemp_db.setStore('apps');
        	  attemp_db.get(appLink, appData => {
        	    if (appData)
            	  attemp_db.update({appName:appLink,html:e.data.xml})
            	else
            	  attemp_db.insert({appName:appLink,html:e.data.xml})
        	  })
        	  
            // document.head.appendChild(loadManifest());
            // window.addEventListener('beforeinstallprompt', function() {
              // L('install load')
            // });
          }
          
          if (document.readyState == 'complete') {
            thorLoad(data.js)
          } else {
            document.onreadystatechange = function () {
              if (document.readyState == 'complete')
                thorLoad(data.js)
            }
          }
          
        } else if (e.data.type === 'reload') {
          if (location.href.indexOf('#') > 0)
            location.reload(true);
          else
            location.href = location.href;
        }
        
      }
        
      if (window.opener !== null)
        window.opener.postMessage({type: 'loaded'},'*');
      
      function handleInstall(e) {
        
        e.preventDefault();
        let attempt = 0;
        let interval = setInterval(() => {
          
          if (attempt > 10 || typeof(installHandler) !== 'undefined')
            clearInterval(interval);
            
          if (typeof(installHandler) !== 'undefined')
            installHandler(e);
            
          attempt++;
          
        }, 100);
      }
      
    })();
  
  </script>
  
</body>
</html>